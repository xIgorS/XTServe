@page "/dbstats-simple"
@using XTWeb.Models
@using XTWeb.Services
@inject IDbStatsService DbStatsService
@inject ILogger<DbStatsSimple> Logger
@rendermode InteractiveServer

<PageTitle>DB Statistics (Simple)</PageTitle>

<h3>Database Statistics (No MudBlazor)</h3>

<div style="background: #f0f0f0; padding: 10px; margin: 10px 0;">
    <strong>Debug Info:</strong><br/>
    isLoading: @isLoading<br/>
    hasInitialized: @hasInitialized<br/>
    dbStats: @(dbStats == null ? "null" : $"{dbStats.Count} items")<br/>
    errorMessage: @(string.IsNullOrEmpty(errorMessage) ? "none" : errorMessage)<br/>
    loadingStatus: @loadingStatus
</div>

@if (isLoading)
{
    <div style="padding: 20px;">
        <p><strong>? Loading database statistics...</strong></p>
        <p>@loadingStatus</p>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div style="background: #ffebee; padding: 15px; border-left: 4px solid #f44336; margin: 10px 0;">
        <strong>? Error:</strong> @errorMessage
        <br/><br/>
        <button @onclick="LoadDataAsync">Retry</button>
    </div>
}
else if (dbStats == null || !dbStats.Any())
{
    <div style="background: #fff3e0; padding: 15px; border-left: 4px solid #ff9800; margin: 10px 0;">
        <strong>?? Warning:</strong> No database statistics available.
    </div>
}
else
{
    <div style="background: #e8f5e9; padding: 15px; border-left: 4px solid #4caf50; margin: 10px 0;">
        <strong>? Success:</strong> Loaded @dbStats.Count records at @loadedTime
    </div>
    
    <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; margin-top: 10px;">
        <thead style="background: #e0e0e0;">
            <tr>
                <th>Database Name</th>
                <th>Logical File Name</th>
                <th>File Type</th>
                <th>Allocated (MB)</th>
                <th>Used (MB)</th>
                <th>Free (MB)</th>
                <th>Used %</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var stat in dbStats)
            {
                <tr>
                    <td>@stat.DatabaseName</td>
                    <td>@stat.LogicalFileName</td>
                    <td>@stat.FileType</td>
                    <td>@stat.AllocatedSpaceMB.ToString("N2")</td>
                    <td>@stat.UsedSpaceMB.ToString("N2")</td>
                    <td>@stat.FreeSpaceMB.ToString("N2")</td>
                    <td>@stat.UsedPercent.ToString("N2")%</td>
                </tr>
            }
        </tbody>
    </table>
}

<div style="margin-top: 20px;">
    <button @onclick="LoadDataAsync" disabled="@isLoading">
        @(isLoading ? "Loading..." : "Refresh Data")
    </button>
</div>

@code {
    private List<DbStat>? dbStats;
    private bool isLoading = false;
    private string? errorMessage;
    private string loadingStatus = "Initializing component...";
    private string? loadedTime;
    private bool hasInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasInitialized)
        {
            hasInitialized = true;
            Logger.LogInformation("DbStatsSimple page - first render, starting data load");
            
            // Start loading in background - don't await to prevent blocking render
            _ = Task.Run(async () =>
            {
                try
                {
                    await InvokeAsync(async () => await LoadDataAsync());
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Fatal error in OnAfterRenderAsync");
                    try
                    {
                        await InvokeAsync(() =>
                        {
                            errorMessage = $"Critical error: {ex.Message}";
                            isLoading = false;
                            StateHasChanged();
                        });
                    }
                    catch (Exception innerEx)
                    {
                        Logger.LogError(innerEx, "Failed to update UI with error");
                    }
                }
            });
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            loadingStatus = "Calling API...";
            Logger.LogInformation("Starting LoadDataAsync");
            StateHasChanged();
            
            Logger.LogInformation("About to call DbStatsService.GetDbStatsAsync");
            dbStats = await DbStatsService.GetDbStatsAsync();
            Logger.LogInformation($"Service returned {dbStats?.Count ?? 0} records");
            
            loadedTime = DateTime.Now.ToString("HH:mm:ss");
            
            if (dbStats == null || !dbStats.Any())
            {
                errorMessage = "No data returned from the API.";
                Logger.LogWarning("No data returned from API");
            }
            else
            {
                Logger.LogInformation($"Successfully loaded {dbStats.Count} records");
            }
        }
        catch (TaskCanceledException ex)
        {
            Logger.LogError(ex, "Request timed out");
            errorMessage = $"Request timed out: {ex.Message}";
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "HTTP request failed");
            errorMessage = $"Unable to connect to API: {ex.Message}. Make sure XTServe is running on https://localhost:7001";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error loading data");
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            loadingStatus = "Complete";
            Logger.LogInformation("LoadDataAsync completed, isLoading = false");
            StateHasChanged();
        }
    }
}
