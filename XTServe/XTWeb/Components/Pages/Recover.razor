@page "/recover"
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Circuit Recovery</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Style="max-width: 800px; margin: 50px auto; padding: 20px;">
    <FluentMessageBar Intent="MessageIntent.Info" Style="margin-bottom: 20px;">
        <FluentLabel Typo="Typography.H6">?? Blazor Circuit Recovery</FluentLabel>
        <FluentLabel>If you experienced a page crash or "all pages stopped working", you're on the recovery page.</FluentLabel>
    </FluentMessageBar>

    <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-bottom: 20px;">
        <FluentLabel Typo="Typography.H6">What Happened?</FluentLabel>
        <FluentLabel>The Blazor SignalR circuit crashed due to an unhandled exception. This typically happens when:</FluentLabel>
        <ul style="margin: 10px 0;">
            <li>The API is not accessible (XTServe not running)</li>
            <li>A component throws an unhandled exception</li>
            <li>Network connection was interrupted</li>
            <li>A timeout occurred during data loading</li>
        </ul>
    </FluentMessageBar>

    <FluentMessageBar Intent="MessageIntent.Success" Style="margin-bottom: 20px;">
        <FluentLabel Typo="Typography.H6">? Circuit Has Been Fixed</FluentLabel>
        <FluentLabel>The following changes have been made to prevent future crashes:</FluentLabel>
        <ul style="margin: 10px 0;">
            <li>Added global ErrorBoundary to catch unhandled exceptions</li>
            <li>Fixed async lifecycle methods to prevent circuit crashes</li>
            <li>Added comprehensive error handling in data loading</li>
            <li>Improved logging for better diagnostics</li>
        </ul>
    </FluentMessageBar>

    <FluentCard Style="margin-bottom: 20px; padding: 20px;">
        <FluentLabel Typo="Typography.H5">?? Quick Diagnostics</FluentLabel>
        
        <FluentStack Orientation="Orientation.Vertical" Style="margin: 20px 0;">
            <FluentLabel Typo="Typography.H6">Step 1: Check XTServe Status</FluentLabel>
            <FluentLabel>XTServe API must be running on port 7001</FluentLabel>
            <FluentButton Appearance="Appearance.Accent" OnClick="TestApiDirectly">
                Test XTServe Connection
            </FluentButton>
        </FluentStack>

        @if (!string.IsNullOrEmpty(apiTestResult))
        {
            <FluentCard Style="margin: 10px 0; padding: 15px;">
                <pre style="margin: 0; white-space: pre-wrap;">@apiTestResult</pre>
            </FluentCard>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="margin: 20px 0;">
            <FluentLabel Typo="Typography.H6">Step 2: Try Simple Test</FluentLabel>
            <FluentLabel>Verify basic Blazor functionality works</FluentLabel>
            <FluentButton Appearance="Appearance.Neutral" OnClick='() => Navigation.NavigateTo("/test")'>
                Go to Test Page
            </FluentButton>
        </FluentStack>

        <FluentStack Orientation="Orientation.Vertical" Style="margin: 20px 0;">
            <FluentLabel Typo="Typography.H6">Step 3: Try DB Stats (Simple)</FluentLabel>
            <FluentLabel>Test data loading without complex components</FluentLabel>
            <FluentButton Appearance="Appearance.Neutral" OnClick='() => Navigation.NavigateTo("/dbstats-simple")'>
                Go to Simple DB Stats
            </FluentButton>
        </FluentStack>
    </FluentCard>

    <FluentCard Style="margin-top: 30px; padding: 20px;">
        <FluentLabel Typo="Typography.H5">?? Next Steps</FluentLabel>
        <ol style="margin: 10px 0;">
            <li><strong>Ensure XTServe is running:</strong>
                <pre style="background: #f5f5f5; padding: 10px; margin: 10px 0;">dotnet run --project C:\Repos\XTServe\XTServe\XTServe.csproj</pre>
            </li>
            <li><strong>Reload this application:</strong> Press F5 or Ctrl+R</li>
            <li><strong>Try diagnostic pages in order:</strong>
                <ul>
                    <li>/test - Basic functionality</li>
                    <li>/diagnostics - API connection test</li>
                    <li>/dbstats-simple - Data loading test</li>
                    <li>/dbstats - Full page</li>
                </ul>
            </li>
        </ol>
    </FluentCard>

    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" Style="margin-top: 20px;">
        <FluentButton Appearance="Appearance.Accent" OnClick='() => Navigation.NavigateTo("/")'>
            ?? Return to Home
        </FluentButton>
    </FluentStack>
</FluentStack>

@code {
    private string? apiTestResult;

    private async Task TestApiDirectly()
    {
        apiTestResult = "Testing...";
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient(new HttpClientHandler
            {
                UseDefaultCredentials = true,
                ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
            });
            
            var response = await client.GetAsync("https://localhost:7001/api/DbStats");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                apiTestResult = $"? SUCCESS\nStatus: {response.StatusCode}\nContent Length: {content.Length} chars\n\nXTServe is accessible!";
            }
            else
            {
                apiTestResult = $"? FAILED\nStatus: {response.StatusCode}\n\nXTServe responded but returned an error.";
            }
        }
        catch (HttpRequestException ex)
        {
            apiTestResult = $"? CONNECTION FAILED\n\nUnable to reach XTServe at https://localhost:7001\n\nError: {ex.Message}\n\nMake sure XTServe is running!";
        }
        catch (Exception ex)
        {
            apiTestResult = $"? ERROR\n\n{ex.Message}";
        }
        
        StateHasChanged();
    }
}
